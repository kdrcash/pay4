<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>네트급여 계산기</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif; background:#f3f4f6 }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:1rem; }
  </style>
</head>
<body class="p-4 sm:p-6 flex items-center justify-center min-h-screen">
  <main class="w-full max-w-[1280px] xl:max-w-[1400px]">
    <!-- 헤더 -->
    <section class="card p-5 sm:p-7 mb-4">
      <div class="flex items-center justify-between gap-3">
        <h1 class="text-3xl sm:text-[2rem] font-extrabold leading-tight text-gray-900">네트급여 계산기</h1>
        <div class="flex items-center gap-2">
          <label class="text-xs sm:text-sm text-gray-600 border rounded-lg px-2 py-1 cursor-pointer">
            세액표 파일 선택
            <input id="tax_file_input" type="file" accept="application/json" class="hidden">
          </label>
          <button id="ver_btn" type="button" class="text-blue-600 font-semibold hover:text-blue-800 underline">Ver 2.0</button>
        </div>
      </div>
    </section>

    <!-- 본문 -->
    <section class="card p-6">
      <!-- 입력 -->
      <div class="bg-white rounded-2xl p-6 md:p-8 border">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-gray-700 font-semibold mb-2">실수령액 (원)</label>
            <input id="net_pay" type="text" inputmode="numeric"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="예: 9,991,000">
          </div>
          <div>
            <label class="block text-gray-700 font-semibold mb-2">비과세 합계(월) — 식대/자가운전 등 (원)</label>
            <input id="nontax" type="text" inputmode="numeric"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="예: 200,000 (없으면 0)">
            <p id="table_status" class="text-[11px] text-gray-400 mt-1">세액표 불러오는 중…</p>
          </div>
        </div>

        <button id="calc_btn"
          class="mt-4 w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
          disabled>계산하기</button>

        <!-- 결과 -->
        <div id="result" class="bg-gray-50 rounded-lg p-6 mt-6 hidden">
          <h2 class="text-xl font-bold text-gray-800 mb-4">계산 결과</h2>

          <!-- 지급총액: 기본급(과세) + 비과세 -->
          <div class="grid grid-cols-2 gap-2 text-sm">
            <div class="bg-white rounded-lg border p-3">
              <div class="text-gray-600">기본급(과세)</div>
              <div id="base_salary_result" class="font-semibold text-gray-900 mt-1"></div>
            </div>
            <div class="bg-white rounded-lg border p-3">
              <div class="text-gray-600">비과세</div>
              <div id="nontax_result" class="font-semibold text-gray-900 mt-1"></div>
            </div>
          </div>
          <div class="mt-2 bg-white rounded-lg border p-3 text-sm">
            <div class="text-gray-600">총 지급액</div>
            <div id="gross_pay_result" class="font-semibold text-gray-900 mt-1"></div>
          </div>

          <!-- 공제 총액 -->
          <div class="mt-2 bg-white rounded-lg border p-3 text-sm">
            <div class="text-gray-600">공제액 합계(근로자 부담)</div>
            <div id="deductions_total_result" class="font-semibold text-gray-900 mt-1"></div>
          </div>

          <!-- 연봉 -->
          <div class="mt-4 grid grid-cols-2 gap-2 text-sm">
            <div class="bg-white rounded-lg border p-3">
              <div class="text-gray-700 font-medium">연봉(퇴직금 제외)</div>
              <div id="annual_excl" class="font-semibold text-gray-900 mt-1"></div>
              <div class="text-[11px] text-gray-500 mt-1">(= 총 지급액 × 12)</div>
            </div>
            <div class="bg-white rounded-lg border p-3">
              <div class="text-gray-700 font-medium">연봉(퇴직금 포함)</div>
              <div id="annual_incl" class="font-semibold text-gray-900 mt-1"></div>
              <div class="text-[11px] text-gray-500 mt-1">(= 총 지급액 × 13)</div>
            </div>
          </div>

          <!-- 부담 요약 -->
          <div class="mt-6 space-y-1 text-sm">
            <div class="flex justify-between"><span class="text-gray-700">+ 4대보험 총액(근로자+사업주)</span><span id="social_total_summary" class="font-semibold text-gray-900"></span></div>
            <div class="flex justify-between"><span class="text-gray-700">+ 원천세 총액(소득세+지방소득세)</span><span id="withholding_total_summary" class="font-semibold text-gray-900"></span></div>
            <div class="border-t border-gray-300 my-1"></div>
            <div class="flex justify-between"><span class="text-gray-700">= 부대비용 총액(퇴직금 제외)</span><span id="overhead_excl_gratuity" class="font-semibold text-gray-900"></span></div>
            <div class="flex justify-between"><span class="text-gray-700">+ 퇴직금 (총 지급액의 1/12)</span><span id="gratuity_summary" class="font-semibold text-gray-900"></span></div>
            <div class="border-t border-gray-300 my-1"></div>
            <div class="flex justify-between"><span class="text-gray-700">= 부대비용 총액(퇴직금 포함)</span><span id="overhead_incl_gratuity" class="font-semibold text-gray-900"></span></div>
          </div>

          <!-- 세부 공제 -->
          <div class="mt-6">
            <h3 class="text-lg font-bold text-gray-700 mb-2">세부 공제 내역</h3>
            <ul class="text-sm text-gray-600 space-y-1">
              <li class="flex justify-between"><span>국민연금 (4.5%)</span><span id="np_deduction"></span></li>
              <li class="flex justify-between"><span>건강보험 (3.545%)</span><span id="hi_deduction"></span></li>
              <li class="flex justify-between"><span>장기요양 (건보료의 12.95%)</span><span id="ltc_deduction"></span></li>
              <li class="flex justify-between"><span>고용보험 (0.9%)</span><span id="ei_deduction"></span></li>
              <li class="flex justify-between"><span>소득세 (간이세액표/법정식)</span><span id="tax_deduction"></span></li>
              <li class="flex justify-between"><span>지방소득세 (10%)</span><span id="local_tax_deduction"></span></li>
            </ul>

            <!-- 사업주 부담 -->
            <div class="mt-6 border-t pt-4">
              <h4 class="text-base font-bold text-gray-700 mb-2">사업주 부담분</h4>
              <ul class="text-sm text-gray-600 space-y-1">
                <li class="flex justify-between"><span>국민연금 (4.5%)</span><span id="np_er"></span></li>
                <li class="flex justify-between"><span>건강보험 (3.545%)</span><span id="hi_er"></span></li>
                <li class="flex justify-between"><span>장기요양 (건보료의 12.95%)</span><span id="ltc_er"></span></li>
                <li class="flex justify-between"><span>고용보험 (1.15%)</span><span id="ei_er"></span></li>
                <li class="flex justify-between"><span>산재보험 (0.72%)</span><span id="wci_er"></span></li>
                <li class="flex justify-between font-semibold pt-1"><span>4대보험 사업주 부담분</span><span id="er_total"></span></li>
              </ul>

              <details class="mt-4 text-[11px] text-gray-500">
                <summary class="cursor-pointer">기준 금액(보수월액/세액표 기준) 보기</summary>
                <div class="mt-2 space-y-1">
                  <div class="flex justify-between"><span>보수월액(비과세 제외)</span><span id="base_ins"></span></div>
                  <div class="flex justify-between"><span>국민연금 기준소득(천원단위·상·하한)</span><span id="base_np"></span></div>
                  <div class="flex justify-between"><span>건강보험 산정기준(상·하한)</span><span id="base_hi"></span></div>
                  <div class="flex justify-between"><span>고용보험 산정기준</span><span id="base_ei"></span></div>
                  <div class="flex justify-between"><span>간이세액표 기준금액</span><span id="base_tax"></span></div>
                </div>
              </details>
            </div>
          </div>
        </div>

        <!-- 에러 -->
        <div id="error_message" class="text-center text-red-500 mt-4 hidden">유효한 금액을 입력해 주세요.</div>
      </div>
    </section>

    <!-- 푸터 -->
    <section class="card p-4 text-center mt-4">
      <footer class="text-xs text-gray-500">© 2024 한국병의원데이터. All Rights Reserved</footer>
    </section>
  </main>

  <!-- 모달 -->
  <div id="ver_modal" class="fixed inset-0 z-50 hidden items-center justify-center">
    <div class="absolute inset-0 bg-black/50"></div>
    <div role="dialog" aria-modal="true" class="relative w-full max-w-md mx-4 bg-white rounded-2xl shadow-2xl p-6">
      <div class="flex items-start justify-between mb-3">
        <h3 class="text-lg font-bold text-gray-800">버전 2.0 • 계산 규칙</h3>
        <button id="ver_close" class="p-2 -m-2 rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="닫기">✕</button>
      </div>
      <div class="text-sm text-gray-700 space-y-4">
        <ul class="list-disc pl-5 space-y-1">
          <li>간이세액표(1인) JSON 로드 — 못 찾는 경우 법정 세율·누진공제로 보완</li>
          <li>근로소득공제 법정식 적용(연→월 환산)</li>
          <li>4대보험 상·하한 반영 · 모든 세목/보험 10원 절사</li>
          <li>국민연금 기준소득: 천원단위 내림 · 장기요양 = 건보료 × 12.95%</li>
        </ul>
      </div>
      <div class="mt-5 flex justify-end">
        <button id="ver_ok" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">확인</button>
      </div>
    </div>
  </div>

  <script>
    // ===== 유틸 =====
    const fmt = n => new Intl.NumberFormat('ko-KR').format(Math.round(n))+' 원';
    const fmtPct = n => new Intl.NumberFormat('ko-KR',{minimumFractionDigits:1,maximumFractionDigits:1}).format(n)+' %';
    const trunc10 = v => Math.floor(v/10)*10;
    const clamp = (x,lo,hi)=>Math.min(Math.max(x,lo),hi);
    const num = el => parseFloat((el.value||'0').replace(/[^\d]/g,''))||0;
    const bindComma = el => el.addEventListener('input', e => {
      const d = e.target.value.replace(/[^\d]/g,'');
      e.target.value = d ? new Intl.NumberFormat('ko-KR').format(+d) : '';
    });

    // ===== DOM =====
    const netInput = document.getElementById('net_pay');
    const nonTaxInput = document.getElementById('nontax');
    const statusEl = document.getElementById('table_status');
    const calcBtn = document.getElementById('calc_btn');
    const taxFileInput = document.getElementById('tax_file_input');

    bindComma(netInput); bindComma(nonTaxInput);

    // ===== 파라미터(보험/상·하한) =====
    const NP_MIN=400_000, NP_MAX=6_370_000;
    const HI_MIN=279_266, HI_MAX=127_056_982;
    const NP_RATE=0.0450, HI_RATE=0.03545, LTC_RATE=0.1295, EI_RATE=0.0090;
    const NP_ER_RATE=0.0450, HI_ER_RATE=0.03545, LTC_ER_RATE=0.1295, EI_ER_RATE=0.0115, WCI_ER_RATE=0.0072;
    const TAX_ZERO_THRESHOLD = 1_060_000; // 면세 한계(월)

    // ===== 모달 =====
    const verBtn = document.getElementById('ver_btn');
    const verModal = document.getElementById('ver_modal');
    const verClose = document.getElementById('ver_close');
    const verOk = document.getElementById('ver_ok');
    verBtn.addEventListener('click', ()=>{ verModal.classList.remove('hidden'); verModal.classList.add('flex'); document.body.classList.add('overflow-hidden'); });
    function closeModal(){ verModal.classList.add('hidden'); verModal.classList.remove('flex'); document.body.classList.remove('overflow-hidden'); }
    verClose && verClose.addEventListener('click', closeModal);
    verOk && verOk.addEventListener('click', closeModal);
    verModal.addEventListener('click', (e)=>{ const dialog=e.currentTarget.querySelector('[role="dialog"]'); if(dialog && !dialog.contains(e.target)) closeModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

    // ===== 간이세액표 로딩 =====
    let TAX_TABLE=[], tableReady=false;
    const TAX_TABLE_URLS = [
      './simplified_tax_table_2024_1person.v2.json',
      '/mnt/data/simplified_tax_table_2024_1person.v2.json',
    ];
    async function fetchJSON(url){ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
    function setTableAndReady(list){
      TAX_TABLE = (Array.isArray(list)? list: []).slice().sort((a,b)=>a.min_won-b.min_won);
      tableReady = TAX_TABLE.length>0; statusEl.textContent = tableReady ? '세액표 로드 완료' : '세액표 형식 오류';
      calcBtn.disabled = !tableReady;
    }
    async function loadTax(){
      const qp = new URL(location.href).searchParams.get('table');
      const candidates = qp ? [qp, ...TAX_TABLE_URLS] : TAX_TABLE_URLS;
      for(const url of candidates){
        try{ const j = await fetchJSON(url); setTableAndReady(j); if(tableReady) return; }catch(_){}
      }
      statusEl.textContent='세액표 자동 로드 실패: 파일을 직접 선택하세요.';
    }
    taxFileInput.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      try{ const data = JSON.parse(await f.text()); setTableAndReady(data); }
      catch(err){ statusEl.textContent='세액표 파일 읽기 실패: '+(err?.message||err); tableReady=false; calcBtn.disabled=true; }
    });
    loadTax();

    // 표 이진탐색
    function lookupTable(x){
      let lo=0,hi=TAX_TABLE.length-1;
      while(lo<=hi){
        const m=(lo+hi)>>1,row=TAX_TABLE[m];
        if(x<row.min_won) hi=m-1; else if(x>=row.max_won) lo=m+1;
        else return {found:true,tax:+row.tax||0};
      }
      return {found:false,tax:0};
    }

    // ===== 근로소득공제(연기준) → 월환산 =====
    function employmentDeductionMonthly(annualGross){
      let ded=0;
      if (annualGross <= 5_000_000) ded = annualGross * 0.70;
      else if (annualGross <= 15_000_000) ded = 3_500_000 + (annualGross-5_000_000)*0.40;
      else if (annualGross <= 45_000_000) ded = 7_500_000 + (annualGross-15_000_000)*0.15;
      else if (annualGross <= 100_000_000) ded = 12_000_000 + (annualGross-45_000_000)*0.10;
      else if (annualGross <= 120_000_000) ded = 17_500_000 + (annualGross-100_000_000)*0.05;
      else ded = 18_500_000; // 상한
      return Math.floor(ded/12);
    }

    // ===== 2025 누진세율·누진공제(결정세액 백업용) =====
    const BRACKETS_2025 = [
      { up:14_000_000, rate:0.06, ded:0 },
      { up:50_000_000, rate:0.15, ded:1_260_000 },
      { up:88_000_000, rate:0.24, ded:5_760_000 },
      { up:150_000_000, rate:0.35, ded:15_440_000 },
      { up:300_000_000, rate:0.38, ded:19_940_000 },
      { up:500_000_000, rate:0.40, ded:25_940_000 },
      { up:1_000_000_000, rate:0.42, ded:35_940_000 },
      { up:Infinity, rate:0.45, ded:65_940_000 },
    ];

    function progressiveTaxMonthly(baseIns){
      // baseIns: 비과세 제외 월지급액
      const annualGross = baseIns*12;
      const empDedMonth = employmentDeductionMonthly(annualGross);
      const taxable = Math.max(0, annualGross - empDedMonth*12); // 근로소득공제 반영

      let annualTax=0;
      for(const b of BRACKETS_2025){
        if(taxable <= b.up){ annualTax = taxable*b.rate - b.ded; break; }
      }
      return trunc10(Math.max(0, annualTax/12));
    }

    // ===== 간이세액 (표 우선, 실패 시 법정식 백업) =====
    function simplifiedTax(amountExclNT){
      const r=lookupTable(amountExclNT);
      if(r.found) return trunc10(r.tax);
      return progressiveTaxMonthly(amountExclNT);
    }

    // ===== 핵심 계산(실수령 → 역산) =====
    function compute(netPay, nonTax){
      if(!tableReady || netPay<=0){ return null; }

      // 고정점 반복으로 지급총액(과세분 기본급 + 비과세) 역산
      const approx = NP_RATE + HI_RATE + (HI_RATE*LTC_RATE) + EI_RATE; // 대략 공제율
      let gross = netPay / (1 - approx); // 초기치 (총 지급액)

      for(let i=0;i<160;i++){
        const baseSalary = Math.max(gross - nonTax, 0);               // 과세 기본급
        const npBaseRaw = Math.floor(baseSalary/1000)*1000;
        const baseNP = clamp(npBaseRaw, NP_MIN, NP_MAX);
        const baseHI = clamp(baseSalary, HI_MIN, HI_MAX);
        const baseEI = baseSalary;

        const np  = trunc10(baseNP * NP_RATE);
        const hi  = trunc10(baseHI * HI_RATE);
        const ltc = trunc10(hi * LTC_RATE);
        const ei  = trunc10(baseEI * EI_RATE);

        // 면세 기준
        const tax = baseSalary < TAX_ZERO_THRESHOLD ? 0 : trunc10(simplifiedTax(baseSalary));
        const ltax = baseSalary < TAX_ZERO_THRESHOLD ? 0 : trunc10(tax * 0.1);

        const total = np + hi + ltc + ei + tax + ltax;
        const newGross = netPay + total;
        if (Math.abs(newGross - gross) < 1) { gross = newGross; break; }
        gross = newGross;
      }

      // 최종 산출
      const baseSalary = Math.max(gross - nonTax, 0);
      const npBaseRaw = Math.floor(baseSalary/1000)*1000;
      const baseNP = clamp(npBaseRaw, NP_MIN, NP_MAX);
      const baseHI = clamp(baseSalary, HI_MIN, HI_MAX);
      const baseEI = baseSalary;

      const np  = trunc10(baseNP * NP_RATE);
      const hi  = trunc10(baseHI * HI_RATE);
      const ltc = trunc10(hi * LTC_RATE);
      const ei  = trunc10(baseEI * EI_RATE);

      const tax  = baseSalary < TAX_ZERO_THRESHOLD ? 0 : trunc10(simplifiedTax(baseSalary));
      const ltax = baseSalary < TAX_ZERO_THRESHOLD ? 0 : trunc10(tax * 0.1);

      const total = np + hi + ltc + ei + tax + ltax;

      // 사업주 부담
      const np_er  = trunc10(baseNP * NP_ER_RATE);
      const hi_er  = trunc10(baseHI * HI_ER_RATE);
      const ltc_er = trunc10(hi_er * LTC_ER_RATE);
      const ei_er  = trunc10(baseEI * EI_ER_RATE);
      const wci_er = trunc10(baseEI * WCI_ER_RATE);
      const er_total = np_er + hi_er + ltc_er + ei_er + wci_er;

      const social_total = (np + hi + ltc + ei) + er_total;
      const withholding_total = tax + ltax;
      const gratuity = Math.round(gross / 12);
      const overhead_excl = social_total + withholding_total;
      const overhead_incl = overhead_excl + gratuity;

      const total_burden_excl = netPay + overhead_excl;
      const total_burden_incl = netPay + overhead_incl;

      const annual_excl = Math.round(gross * 12);
      const annual_incl = Math.round(gross * 13);

      return {
        // 지급 구조
        baseSalary, nonTax, gross,
        // 공제합계(근로자)
        total,
        // 연간/부담
        annual_excl, annual_incl,
        social_total, withholding_total,
        overhead_excl, overhead_incl,
        gratuity,
        total_burden_excl, total_burden_incl,
        // 세부(근로자)
        np, hi, ltc, ei, tax, ltax,
        // 사업주
        np_er, hi_er, ltc_er, ei_er, wci_er, er_total,
        // 기준표시
        baseIns: baseSalary, baseNP, baseHI, baseEI, baseTax: baseSalary
      };
    }

    // ===== 계산 버튼 =====
    document.getElementById('calc_btn').addEventListener('click', ()=>{
      if(!tableReady){ statusEl.textContent='세액표가 아직 준비되지 않았습니다.'; return; }
      const netPay=num(netInput), nonTax=num(nonTaxInput);
      if(netPay<=0){ document.getElementById('result').classList.add('hidden'); document.getElementById('error_message').classList.remove('hidden'); return; }
      const r=compute(netPay, nonTax); if(!r) return;

      const excl_pct = (r.total_burden_excl / netPay) * 100;
      const incl_pct = (r.total_burden_incl / netPay) * 100;

      // 지급 구조
      document.getElementById('base_salary_result').textContent = fmt(r.baseSalary);
      document.getElementById('nontax_result').textContent = fmt(r.nonTax);
      document.getElementById('gross_pay_result').textContent = fmt(r.gross);

      // 공제 합계
      document.getElementById('deductions_total_result').textContent = fmt(r.total);

      // 연봉/부담
      document.getElementById('annual_excl').textContent = fmt(r.annual_excl);
      document.getElementById('annual_incl').textContent = fmt(r.annual_incl);
      document.getElementById('social_total_summary').textContent = fmt(r.social_total);
      document.getElementById('withholding_total_summary').textContent = fmt(r.withholding_total);
      document.getElementById('overhead_excl_gratuity').textContent = fmt(r.overhead_excl);
      document.getElementById('gratuity_summary').textContent = fmt(r.gratuity);
      document.getElementById('overhead_incl_gratuity').textContent = fmt(r.overhead_incl);

      // 세부 공제(근로자)
      document.getElementById('np_deduction').textContent  = fmt(r.np);
      document.getElementById('hi_deduction').textContent  = fmt(r.hi);
      document.getElementById('ltc_deduction').textContent = fmt(r.ltc);
      document.getElementById('ei_deduction').textContent  = fmt(r.ei);
      document.getElementById('tax_deduction').textContent = fmt(r.tax);
      document.getElementById('local_tax_deduction').textContent = fmt(r.ltax);

      // 사업주 부담
      document.getElementById('np_er').textContent   = fmt(r.np_er);
      document.getElementById('hi_er').textContent   = fmt(r.hi_er);
      document.getElementById('ltc_er').textContent  = fmt(r.ltc_er);
      document.getElementById('ei_er').textContent   = fmt(r.ei_er);
      document.getElementById('wci_er').textContent  = fmt(r.wci_er);
      document.getElementById('er_total').textContent= fmt(r.er_total);

      // 기준 금액
      document.getElementById('base_ins').textContent = fmt(r.baseIns);
      document.getElementById('base_np').textContent  = fmt(r.baseNP);
      document.getElementById('base_hi').textContent  = fmt(r.baseHI);
      document.getElementById('base_ei').textContent  = fmt(r.baseEI);
      document.getElementById('base_tax').textContent = fmt(r.baseTax);

      // 퍼센트
      document.getElementById('overhead_excl_gratuity').dataset.pct = excl_pct;
      document.getElementById('overhead_incl_gratuity').dataset.pct = incl_pct;

      document.getElementById('error_message').classList.add('hidden');
      document.getElementById('result').classList.remove('hidden');
    });

    // 입력 콤마
    bindComma(netInput); bindComma(nonTaxInput);
  </script>
</body>
</html>
