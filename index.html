<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>인건비 예측 계산기</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,'Apple SD Gothic Neo','Noto Sans KR',sans-serif;background:#f3f4f6}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:1rem;}
    .tbl{border-collapse:collapse;width:100%;font-size:14px}
    .tbl th,.tbl td{border:1px solid #e5e7eb;padding:8px 10px;text-align:right;white-space:nowrap}
    .tbl th{background:#f9fafb;text-align:center}
    .tone{background:#fffbcc}
    .lbl{color:#4b5563;font-weight:600}
    .input{width:100%;border:1px solid #d1d5db;border-radius:.5rem;padding:.5rem .75rem;text-align:right;outline:none}
    .input:focus{border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.2)}
    .hint{font-size:11px;color:#6b7280}
  </style>
</head>
<body class="p-4 sm:p-6 flex items-start justify-center min-h-screen">
  <main class="w-full max-w-[1280px] xl:max-w-[1400px] space-y-4">
    <section class="card p-5">
      <div class="flex items-center justify-between gap-3">
        <h1 class="text-2xl sm:text-3xl font-extrabold text-gray-900">인건비 예측</h1>
        <button id="open_rules" class="text-blue-600 underline font-semibold">계산 규칙</button>
      </div>
      <p class="mt-2 text-sm text-gray-600">실수령액 기준으로 지급총액(기본급+비과세)을 역산합니다.</p>
    </section>

    <!-- 입력 영역 -->
    <section class="card p-5">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="lbl block mb-1">실수령액(월)</label>
          <input id="net_pay" type="text" inputmode="numeric" class="input" placeholder="예: 3,000,000">
        </div>
        <div>
          <label class="lbl block mb-1">비과세(식대 등)</label>
          <input id="nontax" type="text" inputmode="numeric" class="input" placeholder="예: 200,000">
        </div>
      </div>
      <div class="mt-4 flex items-center gap-2">
        <button id="calc_btn" class="px-4 py-2 rounded-lg bg-blue-600 text-white font-bold disabled:opacity-50 disabled:cursor-not-allowed" disabled>계산</button>
        <span id="table_status" class="hint">세액표 불러오는 중…</span>
      </div>
    </section>

    <!-- 결과 영역 -->
    <section id="result_card" class="card p-5 hidden">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- 좌: 지급내역(월) -->
        <div>
          <h3 class="text-lg font-bold text-gray-800 mb-2">지급내역 (월)</h3>
          <table class="tbl">
            <tbody>
              <tr><td style="text-align:left">기본급(과세)</td><td id="p_base"></td></tr>
              <tr><td style="text-align:left">비과세(식대 등)</td><td id="p_nontax"></td></tr>
              <tr class="tone"><td style="text-align:left;font-weight:700">지급총액</td><td id="p_total" style="font-weight:700"></td></tr>
            </tbody>
          </table>
        </div>

        <!-- 중: 공제내역(월) -->
        <div>
          <h3 class="text-lg font-bold text-gray-800 mb-2">공제내역 (월)</h3>
          <table class="tbl">
            <tbody>
              <tr><td style="text-align:left">국민연금</td><td id="d_np"></td></tr>
              <tr><td style="text-align:left">건강보험</td><td id="d_hi"></td></tr>
              <tr><td style="text-align:left">장기요양</td><td id="d_ltc"></td></tr>
              <tr><td style="text-align:left">고용보험</td><td id="d_ei"></td></tr>
              <tr><td style="text-align:left">소득세</td><td id="d_itx"></td></tr>
              <tr><td style="text-align:left">지방소득세</td><td id="d_ltx"></td></tr>
              <tr class="tone"><td style="text-align:left;font-weight:700">공제총액</td><td id="d_total" style="font-weight:700"></td></tr>
            </tbody>
          </table>
        </div>

        <!-- 우: 실수령액 -->
        <div>
          <h3 class="text-lg font-bold text-gray-800 mb-2">실수령액</h3>
          <div class="text-2xl font-bold text-blue-600" id="net_take"></div>
        </div>
      </div>
    </section>

    <section class="card p-4 text-center">
      <footer class="text-xs text-gray-500">© 2025 한국병의원데이터. All Rights Reserved</footer>
    </section>
  </main>

  <!-- 규칙 모달 -->
  <div id="rules_modal" class="fixed inset-0 z-50 hidden items-center justify-center">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 p-6">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-lg font-bold text-gray-900">계산 규칙</h3>
        <button id="close_rules" class="p-2 -m-2 rounded-lg hover:bg-gray-100">✕</button>
      </div>
      <ul class="list-disc pl-5 text-sm text-gray-700 space-y-1">
        <li>간이세액표(JSON, 1인) 적용, 누락 시 법정 누진세율·근로소득공제 반영</li>
        <li>국민연금: 천원 내림, 상·하한 적용</li>
        <li>건강보험: 상·하한 적용, 장기요양=건보×12.95%</li>
        <li>고용보험: 보수월액 기준</li>
        <li>모든 세목·보험: 10원 절사</li>
      </ul>
      <div class="text-right mt-4">
        <button id="ok_rules" class="px-4 py-2 rounded-lg bg-blue-600 text-white">확인</button>
      </div>
    </div>
  </div>

  <script>
    /* ========= 유틸 ========= */
    const fmt = n => new Intl.NumberFormat('ko-KR').format(Math.round(n))+' 원';
    const onlyNum = s => parseFloat((s||'0').replace(/[^\d]/g,''))||0;
    const trunc10 = v => Math.floor(v/10)*10;
    const clamp = (x,lo,hi)=>Math.min(Math.max(x,lo),hi);
    const bindComma = el => el.addEventListener('input', e=>{
      const d = e.target.value.replace(/[^\d]/g,'');
      e.target.value = d ? new Intl.NumberFormat('ko-KR').format(+d) : '';
    });

    // 입력 바인딩
    ['net_pay','nontax'].forEach(id=>{
      const el=document.getElementById(id); if(el) bindComma(el);
    });

    // 모달
    const modal=document.getElementById('rules_modal');
    document.getElementById('open_rules').onclick=()=>{modal.classList.remove('hidden'); modal.classList.add('flex')};
    function closeModal(){modal.classList.add('hidden'); modal.classList.remove('flex')}
    document.getElementById('close_rules').onclick=closeModal;
    document.getElementById('ok_rules').onclick=closeModal;
    modal.addEventListener('click',e=>{const d=modal.querySelector('.relative'); if(!d.contains(e.target)) closeModal()});

    /* ========= 파라미터 ========= */
    const NP_MIN=400_000, NP_MAX=6_370_000;
    const HI_MIN=279_266, HI_MAX=127_056_982;
    const NP_RATE=0.0450, HI_RATE=0.03545, LTC_RATE=0.1295, EI_RATE=0.0090;
    const TAX_ZERO_THRESHOLD=1_060_000;

    const BRACKETS_2025 = [
      { up:14_000_000, rate:0.06, ded:0 },
      { up:50_000_000, rate:0.15, ded:1_260_000 },
      { up:88_000_000, rate:0.24, ded:5_760_000 },
      { up:150_000_000, rate:0.35, ded:15_440_000 },
      { up:300_000_000, rate:0.38, ded:19_940_000 },
      { up:500_000_000, rate:0.40, ded:25_940_000 },
      { up:1_000_000_000, rate:0.42, ded:35_940_000 },
      { up:Infinity, rate:0.45, ded:65_940_000 }
    ];

    function earnedIncomeDeduction(annual){
      let d=0;
      if (annual <= 5_000_000) d = annual*0.70;
      else if (annual <= 15_000_000) d = 3_500_000 + (annual-5_000_000)*0.40;
      else if (annual <= 45_000_000) d = 7_500_000 + (annual-15_000_000)*0.15;
      else if (annual <= 100_000_000) d = 12_000_000 + (annual-45_000_000)*0.10;
      else { d = 17_000_000 + (annual-100_000_000)*0.05; d = Math.min(d,20_000_000); }
      return Math.floor(d);
    }

    function progressiveTaxMonthly(baseSalary){
      const annualGross=baseSalary*12;
      const deduction=earnedIncomeDeduction(annualGross);
      const taxable=Math.max(0,annualGross-deduction-1_500_000); // 기본공제 150만
      const b=BRACKETS_2025.find(br=>taxable<=br.up)||BRACKETS_2025.at(-1);
      const annualTax=Math.max(0,taxable*b.rate - b.ded);
      return trunc10(annualTax/12);
    }

    let TAX_TABLE=[],tableReady=false;
    async function loadTable(){
      const status=document.getElementById('table_status');
      async function fetchJson(p){const r=await fetch(p,{cache:'no-store'});if(!r.ok) throw new Error(r.status);return r.json();}
      try{
        try{TAX_TABLE=await fetchJson('./simplified_tax_table_2024_1person.v2.json');}
        catch{TAX_TABLE=await fetchJson('./simplified_tax_table_2024_1person.json');}
        TAX_TABLE.sort((a,b)=>a.min_won-b.min_won);
        tableReady=true; status.textContent='세액표 로드 완료';
        document.getElementById('calc_btn').disabled=false;
      }catch(e){status.textContent='세액표 로드 실패: '+e.message;}
    }
    loadTable();

    function lookupTax(amount){
      let lo=0,hi=TAX_TABLE.length-1;
      while(lo<=hi){
        const m=(lo+hi)>>1,row=TAX_TABLE[m];
        if(amount<row.min_won) hi=m-1;
        else if(amount>=row.max_won) lo=m+1;
        else return trunc10(+row.tax||0);
      }
      return progressiveTaxMonthly(amount);
    }

    /* ========= 계산 ========= */
    document.getElementById('calc_btn').addEventListener('click', ()=>{
      if(!tableReady) return;
      const net=onlyNum(document.getElementById('net_pay').value);
      const nontax=onlyNum(document.getElementById('nontax').value);
      if(net<=0) return;

      // 역산 루프
      let gross=net/0.8;
      for(let i=0;i<100;i++){
        const baseInsRaw=gross-nontax;
        const npBase=clamp(Math.floor(baseInsRaw/1000)*1000,NP_MIN,NP_MAX);
        const hiBase=clamp(baseInsRaw,HI_MIN,HI_MAX);
        const eiBase=baseInsRaw;

        const np=trunc10(npBase*NP_RATE);
        const hi=trunc10(hiBase*HI_RATE);
        const ltc=trunc10(hi*LTC_RATE);
        const ei=trunc10(eiBase*EI_RATE);

        const itx=baseInsRaw<TAX_ZERO_THRESHOLD?0:lookupTax(baseInsRaw);
        const ltx=baseInsRaw<TAX_ZERO_THRESHOLD?0:trunc10(itx*0.10);

        const total=np+hi+ltc+ei+itx+ltx;
        const newGross=net+total+nontax;
        if(Math.abs(newGross-gross)<1){gross=newGross;break;}
        gross=newGross;
      }

      const baseSalary=gross-nontax;
      const baseInsRaw=baseSalary;
      const npBase=clamp(Math.floor(baseInsRaw/1000)*1000,NP_MIN,NP_MAX);
      const hiBase=clamp(baseInsRaw,HI_MIN,HI_MAX);
      const eiBase=baseInsRaw;

      const np=trunc10(npBase*NP_RATE);
      const hi=trunc10(hiBase*HI_RATE);
      const ltc=trunc10(hi*LTC_RATE);
      const ei=trunc10(eiBase*EI_RATE);
      const itx=baseInsRaw<TAX_ZERO_THRESHOLD?0:lookupTax(baseInsRaw);
      const ltx=baseInsRaw<TAX_ZERO_THRESHOLD?0:trunc10(itx*0.10);

      const dedTotal=np+hi+ltc+ei+itx+ltx;
      const payTotal=gross;

      document.getElementById('p_base').textContent=fmt(baseSalary);
      document.getElementById('p_nontax').textContent=fmt(nontax);
      document.getElementById('p_total').textContent=fmt(payTotal);

      document.getElementById('d_np').textContent=fmt(np);
      document.getElementById('d_hi').textContent=fmt(hi);
      document.getElementById('d_ltc').textContent=fmt(ltc);
      document.getElementById('d_ei').textContent=fmt(ei);
      document.getElementById('d_itx').textContent=fmt(itx);
      document.getElementById('d_ltx').textContent=fmt(ltx);
      document.getElementById('d_total').textContent=fmt(dedTotal);

      document.getElementById('net_take').textContent=fmt(net);
      document.getElementById('result_card').classList.remove('hidden');
    });
  </script>
</body>
</html>
