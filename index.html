<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>네트급여 계산기</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS (Excel) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif; background:#f3f4f6 }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:1rem; }
    .tone { background:#fef9c3 }
    .tnum { font-variant-numeric: tabular-nums; font-feature-settings: "tnum"; }
    .nowrap { white-space: nowrap; }
    #annual_table td.num, #annual_table th.num { text-align: right; }
    @media (max-width: 640px){ #annual_table th, #annual_table td { padding: 6px 8px; } }
    .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:50 }
    .modal.show { display:flex }
  </style>
</head>
<body class="p-4 sm:p-6 flex items-center justify-center min-h-screen">

  <main class="w-full max-w-[1280px] xl:max-w-[1400px]">
    <!-- 헤더 -->
    <section class="card p-5 sm:p-7 mb-4">
      <div class="flex items-center justify-between gap-3">
        <h1 class="text-3xl sm:text-[2rem] font-extrabold leading-tight text-gray-900">네트급여 계산기</h1>
        <div class="flex items-center gap-3">
          <button id="input_mode_open" type="button" class="px-2.5 py-1.5 rounded-md border border-blue-300 bg-blue-50 text-blue-700 text-sm hover:bg-blue-100" aria-haspopup="dialog" aria-controls="input_mode_modal">
            입력 기준: <b id="input_mode_label">실수령</b>
          </button>
          <button id="ver_btn" type="button" class="text-blue-600 font-semibold hover:text-blue-800 underline">Ver 2.0</button>
        </div>
      </div>
    </section>

    <!-- 상단 배너 -->
    <div class="px-4 sm:px-5 mb-5">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <a href="https://www.kdrcash.kr/" target="_blank" rel="noopener noreferrer" class="block group">
          <div class="relative w-full aspect-[4/1] rounded-xl overflow-hidden border border-gray-200 shadow-sm">
            <img src="https://github.com/kdrcash/pay/blob/main/%EB%B3%91%EC%9D%98%EC%9B%90%20%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%B6%84%EC%84%9D%20%ED%94%8C%EB%9E%AB%ED%8F%BC%20%EB%8B%A5%ED%84%B0%EC%BA%90%EC%8B%9C.png?raw=true" alt class="absolute inset-0 w-full h-full object-cover transition duration-200 group-hover:opacity-90">
          </div>
        </a>
        <a href="https://www.kdrcash.kr/" target="_blank" rel="noopener noreferrer" class="block group">
          <div class="relative w-full aspect-[4/1] rounded-xl overflow-hidden border border-gray-200 shadow-sm">
            <img src="https://github.com/kdrcash/pay/blob/main/%ED%95%9C%EA%B5%AD%EB%B3%91%EC%9D%98%EC%9B%90%EB%8D%B0%EC%9D%B4%ED%84%B0.png?raw=true" alt class="absolute inset-0 w-full h-full object-cover transition duration-200 group-hover:opacity-90">
          </div>
        </a>
        <a href="https://www.kdrcash.kr/download" target="_blank" rel="noopener noreferrer" class="block group">
          <div class="relative w-full aspect-[4/1] rounded-xl overflow-hidden border border-gray-200 shadow-sm">
            <img src="https://github.com/kdrcash/pay/blob/main/%EB%8B%A5%ED%84%B0%EC%BA%90%EC%8B%9C%20%EB%8B%A4%EC%9A%B4%EB%A1%9C%EB%93%9C.png?raw=true" alt class="absolute inset-0 w-full h-full object-cover transition duration-200 group-hover:opacity-90">
          </div>
        </a>
        <a href="https://www.kdrcash.kr/survey" target="_blank" rel="noopener noreferrer" class="block group">
          <div class="relative w-full aspect-[4/1] rounded-xl overflow-hidden border border-gray-200 shadow-sm">
            <img src="https://github.com/kdrcash/pay/blob/main/%EA%B0%9C%EC%9B%90%EA%B4%80%EB%A0%A8%20%ED%95%84%EC%88%98%EC%9E%90%EB%A3%8C%20%EB%AA%A8%EC%9D%8C.png?raw=true" alt class="absolute inset-0 w-full h-full object-cover transition duration-200 group-hover:opacity-90">
          </div>
        </a>
      </div>
    </div>

    <!-- 본문 -->
    <section class="card p-6">
      <!-- 탭 -->
      <div class="flex items-center justify-center gap-4 mb-4 border-b pb-2">
        <button id="tab_single" type="button" class="px-4 py-2 text-sm font-semibold border-b-2 text-blue-600 font-bold border-blue-600">단일</button>
        <button id="tab_multi"  type="button" class="px-4 py-2 text-sm font-semibold border-b-2 text-gray-500 border-transparent">다중</button>
        <span class="ml-auto text-xs text-gray-500"></span>
      </div>

      <!-- 단일 계산 -->
      <div id="content_single">
        <div class="bg-white rounded-2xl p-6 md:p-8 border">
          <!-- 대표자 세율 -->
          <div class="mb-3">
            <label for="owner_rate_single" class="block text-gray-700 font-semibold mb-2">대표자 소득세율(%)</label>
            <div class="flex flex-col sm:flex-row sm:items-center gap-2">
              <div class="flex items-center gap-2">
                <input id="owner_rate_single" type="text" inputmode="decimal"
                       class="w-36 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 tnum text-right"
                       placeholder="예: 35" value="35">
                <span class="text-sm text-gray-600">%</span>
              </div>
              <div class="text-sm text-gray-600">
                합계 세율: <b id="combined_rate_single" class="text-gray-900 tnum">- %</b>
                <span id="combined_hint_single" class="text-[11px] text-gray-500 ml-1"></span>
              </div>
              <button id="export_single_btn" type="button"
                class="w-full sm:w-36 px-3 py-2 text-sm rounded-lg border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 sm:ml-auto disabled:opacity-50"
                disabled>엑셀로 내보내기</button>
            </div>
          </div>

          <!-- 입력 -->
          <div class="mb-3">
            <label id="primary_input_label" for="net_pay" class="block text-gray-700 font-semibold mb-2">실수령액 (원)</label>
            <input id="net_pay" type="text" inputmode="numeric" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="예: 11,350,000">
          </div>
          <div class="mb-4">
            <label for="nontax" class="block text-gray-700 font-semibold mb-2">비과세 합계 (월) : 식대/자가운전 등 (원)</label>
            <input id="nontax" type="text" inputmode="numeric" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="예: 200,000 (없으면 0)">
            <p id="table_status" class="text-[11px] text-gray-400 mt-1">API 연결 준비 완료</p>
          </div>
          <button id="calc_btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">계산하기</button>

          <!-- 결과 -->
          <div id="result" class="bg-gray-50 rounded-lg p-6 hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4">계산 결과</h2>

            <!-- 월 결과 -->
            <div class="grid grid-cols-2 gap-2 text-sm">
              <div class="bg-white rounded-lg border p-3">
                <div class="text-gray-600">지급총액</div>
                <div id="gross_pay_result" class="font-semibold text-gray-900 mt-1"></div>
              </div>
              <div class="bg-white rounded-lg border p-3">
                <div class="text-gray-600">공제액 합계</div>
                <div id="deductions_total_result" class="font-semibold text-gray-900 mt-1"></div>
              </div>
            </div>

            <!-- 연봉 -->
            <div class="mt-4 grid grid-cols-2 gap-2 text-sm">
              <div class="bg-white rounded-lg border p-3">
                <div class="text-gray-700 font-medium">연봉(퇴직금 제외)</div>
                <div id="annual_excl" class="font-semibold text-gray-900 mt-1"></div>
                <div class="text-[11px] text-gray-500 mt-1">(= 지급총액 × 12)</div>
              </div>
              <div class="bg-white rounded-lg border p-3">
                <div class="text-gray-700 font-medium">연봉(퇴직금 포함)</div>
                <div id="annual_incl" class="font-semibold text-gray-900 mt-1"></div>
                <div class="text-[11px] text-gray-500 mt-1">(= 지급총액 × 13)</div>
              </div>
            </div>

            <!-- 총부담 -->
            <div class="mt-4 grid grid-cols-2 gap-2 text-sm">
              <div class="bg-white rounded-lg border p-3">
                <div class="text-gray-700 font-medium">총부담액(퇴직금 제외)</div>
                <div id="total_burden_excl" class="font-semibold text-gray-900 mt-1"></div>
                <div class="text-[11px] text-gray-500 mt-1">실수령액 대비 <span id="total_burden_excl_pct"></span></div>
              </div>
              <div class="bg-white rounded-lg border p-3">
                <div class="text-gray-700 font-medium">총부담액(퇴직금 포함)</div>
                <div id="total_burden_incl" class="font-semibold text-gray-900 mt-1"></div>
                <div class="text-[11px] text-gray-500 mt-1">실수령액 대비 <span id="total_burden_incl_pct"></span></div>
              </div>
            </div>

            <!-- 실부담/절세 -->
            <div class="mt-2 grid grid-cols-2 gap-2 text-sm">
              <div class="bg-white rounded-lg border p-3">
                <div class="text-gray-700 font-medium">실부담액(퇴직금 제외)</div>
                <div id="real_burden_excl_single" class="font-semibold text-gray-900 mt-1"></div>
                <div class="text-[11px] text-gray-500 mt-1">절세액 <span id="real_burden_excl_saving" class="tnum"></span> 반영</div>
              </div>
              <div class="bg-white rounded-lg border p-3">
                <div class="text-gray-700 font-medium">실부담액(퇴직금 포함)</div>
                <div id="real_burden_incl_single" class="font-semibold text-gray-900 mt-1"></div>
                <div class="text-[11px] text-gray-500 mt-1">절세액 <span id="real_burden_incl_saving" class="tnum"></span> 반영</div>
              </div>
            </div>

            <!-- 합계 요약 -->
            <div class="mt-6 space-y-1 text-sm">
              <div class="flex justify-between"><span class="text-gray-700">+ 4대보험 총액(근로자+사업주)</span><span id="social_total_summary" class="font-semibold text-gray-900"></span></div>
              <div class="flex justify-between"><span class="text-gray-700">+ 원천세 총액(소득세+지방소득세)</span><span id="withholding_total_summary" class="font-semibold text-gray-900"></span></div>
              <div class="border-t border-gray-300 my-1"></div>
              <div class="flex justify-between"><span class="text-gray-700">= 부대비용 총액(퇴직금 제외)</span><span id="overhead_excl_gratuity" class="font-semibold text-gray-900"></span></div>
              <div class="flex justify-between"><span class="text-gray-700">+ 퇴직금 (지급총액의 1/12)</span><span id="gratuity_summary" class="font-semibold text-gray-900"></span></div>
              <div class="border-t border-gray-300 my-1"></div>
              <div class="flex justify-between"><span class="text-gray-700">= 부대비용 총액(퇴직금 포함)</span><span id="overhead_incl_gratuity" class="font-semibold text-gray-900"></span></div>
            </div>

            <!-- 공제 내역 -->
            <div class="mt-6">
              <h3 class="text-lg font-bold text-gray-700 mb-2">세부 공제 내역</h3>
              <ul class="text-sm text-gray-600 space-y-1">
                <li class="flex justify-between"><span>국민연금 (근로자)</span><span id="np_deduction"></span></li>
                <li class="flex justify-between"><span>건강보험 (근로자)</span><span id="hi_deduction"></span></li>
                <li class="flex justify-between"><span>장기요양 (근로자)</span><span id="ltc_deduction"></span></li>
                <li class="flex justify-between"><span>고용보험 (근로자)</span><span id="ei_deduction"></span></li>
                <li class="flex justify-between"><span>소득세</span><span id="tax_deduction"></span></li>
                <li class="flex justify-between"><span>지방소득세</span><span id="local_tax_deduction"></span></li>
              </ul>

              <!-- 사업주 부담 -->
              <div class="mt-6 border-t pt-4">
                <h4 class="text-base font-bold text-gray-700 mb-2">사업주 부담분</h4>
                <ul class="text-sm text-gray-600 space-y-1">
                  <li class="flex justify-between"><span>국민연금 (사업주)</span><span id="np_er"></span></li>
                  <li class="flex justify-between"><span>건강보험 (사업주)</span><span id="hi_er"></span></li>
                  <li class="flex justify-between"><span>장기요양 (사업주)</span><span id="ltc_er"></span></li>
                  <li class="flex justify-between"><span>고용보험 (사업주)</span><span id="ei_er"></span></li>
                  <li class="flex justify-between"><span>산재보험 (사업주)</span><span id="wci_er"></span></li>
                  <li class="flex justify-between font-semibold pt-1"><span>4대보험 사업주 부담분</span><span id="er_total"></span></li>
                </ul>

                <details class="mt-4 text-[11px] text-gray-500">
                  <summary class="cursor-pointer">기준 금액(보수월액/세액표 기준) 보기</summary>
                  <div class="mt-2 space-y-1">
                    <div class="flex justify-between"><span>보수월액(비과세 제외)</span><span id="base_ins"></span></div>
                    <div class="flex justify-between"><span>국민연금 기준소득(천원단위·상·하한)</span><span id="base_np"></span></div>
                    <div class="flex justify-between"><span>건강보험 산정기준(상·하한)</span><span id="base_hi"></span></div>
                    <div class="flex justify-between"><span>고용보험 산정기준</span><span id="base_ei"></span></div>
                    <div class="flex justify-between"><span>간이세액표 기준금액</span><span id="base_tax"></span></div>
                  </div>
                </details>
              </div>
            </div>

            <!-- 연간 표 -->
            <div class="mt-8">
              <div class="flex items-center justify-between gap-2 mb-1">
                <h3 class="text-lg font-bold text-gray-800">세금계산내역 (연간)</h3>
                <button id="annual_toggle" class="text-xs px-2 py-1 rounded-md border text-gray-700 hover:bg-gray-100" type="button" aria-pressed="false">전체 보기</button>
              </div>
              <p class="text-[11px] text-gray-500 mb-2">
                총급여(연) = (월 지급총액 − 월 비과세) × 12 · 표의 ‘기납부세액/차감징수세액’은 소득세만 반영합니다.
              </p>
              <div id="annual_wrapper" class="rounded-lg border border-gray-200 overflow-x-hidden">
                <table id="annual_table" class="w-full text-xs sm:text-sm">
                  <thead class="bg-gray-50 text-gray-700">
                    <tr>
                      <th class="p-1.5 sm:p-2 border-b text-left">구분</th>
                      <th class="p-1.5 sm:p-2 border-b text-right num tnum">금액</th>
                    </tr>
                  </thead>
                  <tbody id="annual_tax_detail" class="bg-white text-gray-800"></tbody>
                </table>
              </div>
            </div>
          </div>

          <div id="error_message" class="text-center text-red-500 mt-4 hidden">유효한 금액을 입력해 주세요.</div>
        </div>
      </div>

      <!-- 다중 계산 -->
      <div id="content_multi" class="hidden">
        <div class="bg-white rounded-2xl p-6 md:p-8 border">

          <!-- 대표자 세율 -->
          <div class="mb-4">
            <label for="owner_rate" class="block text-gray-700 font-semibold mb-2">대표자 소득세율(%)</label>
            <div class="flex flex-col sm:flex-row sm:items-center gap-2">
              <div class="flex items-center gap-2">
                <input id="owner_rate" type="text" inputmode="decimal"
                       class="w-36 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 tnum text-right"
                       placeholder="예: 35" value="35">
                <span class="text-sm text-gray-600">%</span>
              </div>
              <div class="text-sm text-gray-600">
                합계 세율: <b id="combined_rate" class="text-gray-900 tnum">- %</b>
                <span id="combined_hint" class="text-[11px] text-gray-500 ml-1"></span>
              </div>
              <button id="export_multi_btn" type="button"
                class="w-full sm:w-36 px-3 py-2 text-sm rounded-lg border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 sm:ml-auto"
                title="표에 출력된 다중 계산 결과를 엑셀로 저장">엑셀로 내보내기</button>
            </div>
          </div>

          <!-- 안내 + 버튼 -->
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-3">
            <div class="text-sm text-gray-600 leading-relaxed break-keep">
              여러 개의 <span id="multi_hint_label">실수령액 · 지급총액(입력 기준에 따름)</span> & 비과세 금액을 입력하여 요약 결과를 한 번에 확인하세요.
            </div>
            <div class="flex flex-col sm:flex-row gap-2 sm:justify-end">
              <button id="add_row" class="w-full sm:w-28 px-3 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700">+ 행 추가</button>
              <button id="reset_multi" class="w-full sm:w-28 px-3 py-2 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">초기화</button>
              <button id="calc_multi" class="w-full sm:w-28 px-3 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700">다중 계산</button>
            </div>
          </div>

          <!-- 입력 행 -->
          <div id="multi_inputs" class="space-y-2"></div>

          <!-- 결과 표 -->
          <div class="overflow-x-auto mt-4">
            <table class="w-full text-sm border border-gray-200 rounded-lg overflow-hidden min-w-[1650px]">
              <thead class="bg-gray-50 text-gray-700">
                <tr>
                  <th id="th_multi_col1" class="p-2 border-b text-right whitespace-nowrap">실수령액</th>
                  <th class="p-2 border-b text-right whitespace-nowrap">비과세</th>
                  <th class="p-2 border-b text-right whitespace-nowrap">지급총액</th>
                  <th class="p-2 border-b text-right whitespace-nowrap">공제합계</th>
                  <th class="p-2 border-b text-right whitespace-nowrap">연봉 <span class="text-xs text-gray-500">(퇴직금제외)</span></th>
                  <th class="p-2 border-b text-right whitespace-nowrap">연봉 <span class="text-xs text-gray-500">(퇴직금포함)</span></th>
                  <th class="p-2 border-b text-right whitespace-nowrap">총부담 <span class="text-xs text-gray-500">(퇴직금제외)</span></th>
                  <th class="p-2 border-b text-right whitespace-nowrap">총부담% <span class="text-xs text-gray-500">(제외)</span></th>
                  <th class="p-2 border-b text-right whitespace-nowrap">총부담 <span class="text-xs text-gray-500">(퇴직금포함)</span></th>
                  <th class="p-2 border-b text-right whitespace-nowrap">총부담% <span class="text-xs text-gray-500">(포함)</span></th>
                  <th class="p-2 border-b text-right whitespace-nowrap">근로소득금액</th>
                  <th class="p-2 border-b text-right whitespace-nowrap tnum">세율구간</th>
                  <th class="p-2 border-b text-right whitespace-nowrap">결정세액</th>
                  <th class="p-2 border-b text-right whitespace-nowrap">실부담 <span class="text-xs text-gray-500">(퇴직금제외)</span></th>
                  <th class="p-2 border-b text-right whitespace-nowrap">실부담 <span class="text-xs text-gray-500">(퇴직금포함)</span></th>
                </tr>
              </thead>
              <tbody id="multi_results" class="text-gray-800"></tbody>
            </table>
          </div>

          <p id="table_status_multi" class="text-[11px] text-gray-400 mt-1">API 연결 준비 완료</p>
        </div>
      </div>
    </section>

    <!-- 하단 배너 -->
    <div class="px-4 sm:px-5 my-5">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <a href="https://www.kdrcash.kr/download" target="_blank" rel="noopener noreferrer" class="block group">
          <div class="relative w-full aspect-[4/1] rounded-xl overflow-hidden border border-gray-200 shadow-sm">
            <img src="https://github.com/kdrcash/pay/blob/main/%EB%8B%A5%ED%84%B0%EC%BA%90%EC%8B%9C%20%EB%8B%A4%EC%9A%B4%EB%A1%9C%EB%93%9C.png?raw=true" alt class="absolute inset-0 w-full h-full object-cover transition duration-200 group-hover:opacity-90">
          </div>
        </a>
        <a href="https://www.kdrcash.kr/survey" target="_blank" rel="noopener noreferrer" class="block group">
          <div class="relative w-full aspect-[4/1] rounded-xl overflow-hidden border border-gray-200 shadow-sm">
            <img src="https://github.com/kdrcash/pay/blob/main/%EA%B0%9C%EC%9B%90%EA%B4%80%EB%A0%A8%20%ED%95%84%EC%88%98%EC%9E%90%EB%A3%8C%20%EB%AA%A8%EC%9D%8C.png?raw=true" alt class="absolute inset-0 w-full h-full object-cover transition duration-200 group-hover:opacity-90">
          </div>
        </a>
      </div>
    </div>

    <!-- 푸터 -->
    <section class="card p-4 text-center mt-4">
      <footer class="text-xs text-gray-500">© 2024 한국병의원데이터. All Rights Reserved</footer>
    </section>
  </main>

  <!-- Ver 모달 -->
  <div id="ver_modal" class="fixed inset-0 z-50 hidden items-center justify-center">
    <div class="absolute inset-0 bg-black/50"></div>
    <div role="dialog" aria-modal="true" class="relative w-full max-w-md mx-4 bg-white rounded-2xl shadow-2xl p-6">
      <div class="flex items-start justify-between mb-3">
        <h3 class="text-lg font-bold text-gray-800">버전 2.0 • 계산 규칙</h3>
        <button id="ver_close" class="p-2 -m-2 rounded-lg hover:bg-gray-100 focus:ring-2 focus:ring-blue-500" aria-label="닫기">✕</button>
      </div>
      <div class="text-sm text-gray-700 space-y-4">
        <div>
          <h4 class="font-semibold text-gray-900 mb-1">적용 규칙</h4>
          <ul class="list-disc pl-5 space-y-1">
            <li>2024 간이세액표(1인) 적용</li>
            <li>4대보험 상·하한 반영</li>
            <li>장기요양보험료 = 건강보험료 × <b>12.95%</b></li>
            <li>모든 세목·보험 <b>10원 절사</b></li>
            <li>세목·보험 산정 기준: <b>비과세 제외 금액</b></li>
            <li>국민연금 기준소득: <b>천원단위</b>로 내림</li>
          </ul>
        </div>
        <div>
          <h4 class="font-semibold text-gray-900 mb-2">상·하한 | 면세 기준</h4>
          <div class="rounded-lg bg-gray-50 border border-gray-200 p-3 space-y-1 text=[13px]">
            <div class="flex justify-between"><span>국민연금 기준소득월액 하한</span><span id="np_min_label"></span></div>
            <div class="flex justify-between"><span>국민연금 기준소득월액 상한</span><span id="np_max_label"></span></div>
            <div class="flex justify-between"><span>건강보험 보수월액 하한</span><span id="hi_min_label"></span></div>
            <div class="flex justify-between"><span>건강보험 보수월액 상한</span><span id="hi_max_label"></span></div>
            <div class="flex justify-between font-semibold"><span>소득세 면세 기준</span><span id="tax_zero_label"></span></div>
          </div>
        </div>
      </div>
      <div class="mt-5 flex justify-end">
        <button id="ver_ok" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">확인</button>
      </div>
    </div>
  </div>

  <!-- 입력 기준 모달 -->
  <div id="input_mode_modal" class="modal" aria-hidden="true">
    <div class="absolute inset-0 bg-black/50"></div>
    <div role="dialog" aria-modal="true" class="relative w-full max-w-md mx-4 bg-white rounded-2xl shadow-2xl p-6">
      <div class="flex items-start justify-between mb-3">
        <h3 class="text-lg font-bold text-gray-900">입력 기준 선택</h3>
        <button id="input_mode_close" class="p-2 -m-2 rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="닫기">✕</button>
      </div>

      <div class="space-y-3 text-sm">
        <label class="flex items-start gap-3 p-3 rounded-xl border cursor-pointer hover:bg-gray-50">
          <input type="radio" name="input_mode" value="net" class="mt-1.5" checked>
          <div class="flex-1">
            <div class="font-semibold text-gray-900">실수령(세후)</div>
            <p class="text-gray-600 mt-1">입력한 금액을 <b>실수령액</b>으로 보고, 서버에서 <b>지급총액</b>을 역산합니다.</p>
          </div>
        </label>

        <label class="flex items-start gap-3 p-3 rounded-xl border cursor-pointer hover:bg-gray-50">
          <input type="radio" name="input_mode" value="gross" class="mt-1.5">
          <div class="flex-1">
            <div class="font-semibold text-gray-900">지급총액(세전)</div>
            <p class="text-gray-600 mt-1">입력한 금액을 <b>지급총액</b>으로 고정하여 공제를 계산하고, <b>실수령액</b>을 서버에서 산출합니다.</p>
          </div>
        </label>
      </div>

      <div class="mt-5 flex justify-end gap-2">
        <button id="input_mode_apply" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">적용</button>
      </div>
    </div>
  </div>

  <script>
    /* ===== 서버 API 설정 ===== */
    const API_BASE = "https://dgrfavjoudnkjfbibm3k3sinfy0wzdmw.lambda-url.us-east-1.on.aws";
    async function callCalcAPI(payload) {
      const res = await fetch(API_BASE + "/calc", {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=UTF-8" },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error("API 오류: " + res.status);
      return res.json();
    }

    /* ===== 유틸/포맷터 ===== */
    const NF_WON = new Intl.NumberFormat('ko-KR');
    const NF_PCT = new Intl.NumberFormat('ko-KR', { minimumFractionDigits: 1, maximumFractionDigits: 1 });
    const fmt = n => NF_WON.format(Math.round(n)) + ' 원';
    const fmtPct = n => NF_PCT.format(n) + ' %';
    const onlyNumber = v => parseFloat((v || '0').replace(/[^\d]/g, '')) || 0;
    const bindComma = el => el.addEventListener('input', e => {
      const d = e.target.value.replace(/[^\d]/g, '');
      e.target.value = d ? NF_WON.format(+d) : '';
    });

    /* ===== DOM 캐시 ===== */
    const EL = {
      tabSingleBtn: document.getElementById('tab_single'),
      tabMultiBtn: document.getElementById('tab_multi'),
      contentSingle: document.getElementById('content_single'),
      contentMulti: document.getElementById('content_multi'),
      netInput: document.getElementById('net_pay'),
      nonTaxInput: document.getElementById('nontax'),
      primaryInputLabel: document.getElementById('primary_input_label'),
      calcBtn: document.getElementById('calc_btn'),
      statusSingle: document.getElementById('table_status'),
      statusMulti: document.getElementById('table_status_multi'),
      result: document.getElementById('result'),
      error: document.getElementById('error_message'),
      gross: document.getElementById('gross_pay_result'),
      totalDed: document.getElementById('deductions_total_result'),
      annualExcl: document.getElementById('annual_excl'),
      annualIncl: document.getElementById('annual_incl'),
      tbExcl: document.getElementById('total_burden_excl'),
      tbIncl: document.getElementById('total_burden_incl'),
      tbExclPct: document.getElementById('total_burden_excl_pct'),
      tbInclPct: document.getElementById('total_burden_incl_pct'),
      socialSum: document.getElementById('social_total_summary'),
      withholdSum: document.getElementById('withholding_total_summary'),
      overheadExcl: document.getElementById('overhead_excl_gratuity'),
      gratuity: document.getElementById('gratuity_summary'),
      overheadIncl: document.getElementById('overhead_incl_gratuity'),
      np: document.getElementById('np_deduction'),
      hi: document.getElementById('hi_deduction'),
      ltc: document.getElementById('ltc_deduction'),
      ei: document.getElementById('ei_deduction'),
      tax: document.getElementById('tax_deduction'),
      ltax: document.getElementById('local_tax_deduction'),
      np_er: document.getElementById('np_er'),
      hi_er: document.getElementById('hi_er'),
      ltc_er: document.getElementById('ltc_er'),
      ei_er: document.getElementById('ei_er'),
      wci_er: document.getElementById('wci_er'),
      er_total: document.getElementById('er_total'),
      baseIns: document.getElementById('base_ins'),
      baseNP: document.getElementById('base_np'),
      baseHI: document.getElementById('base_hi'),
      baseEI: document.getElementById('base_ei'),
      baseTax: document.getElementById('base_tax'),
      annualToggle: document.getElementById('annual_toggle'),
      annualWrap: document.getElementById('annual_wrapper'),
      annualBody: document.getElementById('annual_tax_detail'),
      annualTable: document.getElementById('annual_table'),
      verBtn: document.getElementById('ver_btn'),
      verModal: document.getElementById('ver_modal'),
      verClose: document.getElementById('ver_close'),
      verOk: document.getElementById('ver_ok'),
      npMinLabel: document.getElementById('np_min_label'),
      npMaxLabel: document.getElementById('np_max_label'),
      hiMinLabel: document.getElementById('hi_min_label'),
      hiMaxLabel: document.getElementById('hi_max_label'),
      taxZeroLabel: document.getElementById('tax_zero_label'),
      inputModeBtn: document.getElementById('input_mode_open'),
      inputModeModal: document.getElementById('input_mode_modal'),
      inputModeClose: document.getElementById('input_mode_close'),
      inputModeApply: document.getElementById('input_mode_apply'),
      inputModeLabel: document.getElementById('input_mode_label'),
      multiInputs: document.getElementById('multi_inputs'),
      multiResults: document.getElementById('multi_results'),
      addRow: document.getElementById('add_row'),
      resetMulti: document.getElementById('reset_multi'),
      calcMulti: document.getElementById('calc_multi'),
      thMultiCol1: document.getElementById('th_multi_col1'),
      multiHintLabel: document.getElementById('multi_hint_label'),
      ownerRateInput: document.getElementById('owner_rate'),
      combinedRateOut: document.getElementById('combined_rate'),
      combinedHint: document.getElementById('combined_hint'),
      ownerRateInputSingle: document.getElementById('owner_rate_single'),
      combinedRateOutSingle: document.getElementById('combined_rate_single'),
      combinedHintSingle: document.getElementById('combined_hint_single'),
      realBurdenExclSingle: document.getElementById('real_burden_excl_single'),
      realBurdenInclSingle: document.getElementById('real_burden_incl_single'),
      realBurdenExclSaving: document.getElementById('real_burden_excl_saving'),
      realBurdenInclSaving: document.getElementById('real_burden_incl_saving'),
      exportSingleBtn: document.getElementById('export_single_btn'),
      exportMultiBtn: document.getElementById('export_multi_btn'),
    };

    /* ===== 탭 전환 ===== */
    const ACTIVE = ['text-blue-600','font-bold','border-blue-600'];
    const INACTIVE = ['text-gray-500','border-transparent'];
    const setActive = (a,b,show,hide) => {
      a.classList.add(...ACTIVE); a.classList.remove(...INACTIVE);
      b.classList.add(...INACTIVE); b.classList.remove(...ACTIVE);
      show.classList.remove('hidden'); hide.classList.add('hidden');
    };
    EL.tabSingleBtn.addEventListener('click', ()=>setActive(EL.tabSingleBtn, EL.tabMultiBtn, EL.contentSingle, EL.contentMulti));
    EL.tabMultiBtn.addEventListener('click',  ()=>setActive(EL.tabMultiBtn, EL.tabSingleBtn, EL.contentMulti, EL.contentSingle));
    setActive(EL.tabSingleBtn, EL.tabMultiBtn, EL.contentSingle, EL.contentMulti);

    /* ===== 입력 포맷 바인딩 ===== */
    bindComma(EL.netInput);
    bindComma(EL.nonTaxInput);
    function parseOwnerRatePctSingle() {
      const raw = (EL.ownerRateInputSingle?.value || '').replace(/[^\d.]/g, '');
      const v = parseFloat(raw);
      return Number.isFinite(v) ? v : 35;
    }
    function parseOwnerRatePct() {
      const raw = (EL.ownerRateInput?.value || '').replace(/[^\d.]/g, '');
      const v = parseFloat(raw);
      return Number.isFinite(v) ? v : 35;
    }

    /* ===== 입력 기준(실수령/지급총액) ===== */
    let inputMode = 'net'; // 'net' | 'gross'
    function openInputMode(){ EL.inputModeModal.classList.add('show'); document.body.classList.add('overflow-hidden'); setInputModeRadios(inputMode); }
    function closeInputMode(){ EL.inputModeModal.classList.remove('show'); document.body.classList.remove('overflow-hidden'); }
    EL.inputModeBtn.addEventListener('click', openInputMode);
    EL.inputModeClose.addEventListener('click', closeInputMode);
    EL.inputModeModal.addEventListener('click', (e)=>{ const dialog=EL.inputModeModal.querySelector('[role="dialog"]'); if(dialog && !dialog.contains(e.target)) closeInputMode(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeInputMode(); });

    function setInputModeRadios(mode){
      const rNet=document.querySelector('input[name="input_mode"][value="net"]');
      const rGross=document.querySelector('input[name="input_mode"][value="gross"]');
      if(!rNet || !rGross) return;
      rNet.checked = (mode==='net');
      rGross.checked = (mode==='gross');
    }
    function updateMultiPlaceholders(){
      const ph = (inputMode==='net' ? '실수령액' : '지급총액');
      document.querySelectorAll('#multi_inputs .net-input')?.forEach(inp=>inp.setAttribute('placeholder', ph));
    }
    function applyInputModeUI(){
      if(inputMode==='net'){
        EL.inputModeLabel.textContent = '실수령';
        EL.primaryInputLabel.textContent = '실수령액 (원)';
        EL.netInput.placeholder = '예: 11,350,000';
      }else{
        EL.inputModeLabel.textContent = '지급총액';
        EL.primaryInputLabel.textContent = '지급총액 (원)';
        EL.netInput.placeholder = '예: 15,000,000';
      }
      EL.thMultiCol1.textContent = '실수령액';
      updateMultiPlaceholders();
    }
    EL.inputModeApply.addEventListener('click', ()=>{
      const selected = document.querySelector('input[name="input_mode"]:checked')?.value || 'net';
      inputMode = selected;
      applyInputModeUI();
      closeInputMode();
    });
    applyInputModeUI();

    /* ===== 대표자 합계세율 라벨(프론트 표시용, 실제 계산은 서버 결과 사용) ===== */
    function renderOwnerCombinedRate(elOut, elHint, ownerPct){
      // 서버도 계산하지만, UI 라벨은 즉시 표시
      // 건보+장기요양의 합계(근로자+사업주)는 서버와 다를 수 있으나, 참고용 라벨
      const HI = 0.03545;
      const LTC = 0.1295;
      const healthBoth = 2 * HI * (1 + LTC); // ~8.008%
      const owner = (ownerPct/100);
      const local = owner * 0.10;
      const total = owner + local + healthBoth;
      if (elOut) elOut.textContent = (total*100).toFixed(1) + ' %';
      if (elHint) elHint.textContent =
        `(소득세 ${(owner*100).toFixed(1)}% + 지방 ${(local*100).toFixed(1)}% + 건보·장기요양 ${(healthBoth*100).toFixed(2)}%)`;
    }
    function attachOwnerRateUI(){
      const handlerSingle = ()=>renderOwnerCombinedRate(EL.combinedRateOutSingle, EL.combinedHintSingle, parseOwnerRatePctSingle());
      const handlerMulti  = ()=>renderOwnerCombinedRate(EL.combinedRateOut, EL.combinedHint, parseOwnerRatePct());
      EL.ownerRateInputSingle?.addEventListener('input', handlerSingle);
      EL.ownerRateInput?.addEventListener('input', handlerMulti);
      handlerSingle(); handlerMulti();
    }
    attachOwnerRateUI();

    /* ===== 전역 상태 (단일) - 엑셀 내보내기용 ===== */
    let lastServerResult = null;   // data.result
    let lastServerReal   = null;   // data.real
    let lastServerAnnual = null;   // data.annual
    let lastOwnerRatePct = 35;
    let lastInputMode    = 'net';

    /* ===== 연간 표 렌더링 (서버 응답 사용) ===== */
    const SUMMARY_KEYS = new Set(['총급여','과세표준','산출세액','결정세액','기납부세액(소득세)','차감징수세액(소득세)','차감징수지방세(10%)']);
    let annualFull = false;

    function renderAnnualFromServer(res, annual){
      // res: data.result, annual: data.annual
      const annualSalary = Math.max(0, Math.round((res.gross - res.nonTax) * 12));
      const rows = [
        ['총급여', annualSalary],
        ['근로소득공제', annual.earnedDed],
        ['근로소득금액', annual.earnedIncomeAmt],
        ['기본공제', 1_500_000],
        ['과세표준', annual.taxBase],
        ['세율', (annual.topRate*100).toFixed(0)+' %'],
        ['산출세액', annual.finalIncomeTax + annual.earnedIncomeTaxCredit /* 역산 불가 시 산출세액=결정+공제 대략*/],
        ['근로소득세액공제', annual.earnedIncomeTaxCredit ?? 0],
        ['표준세액공제', 130_000],
        ['결정세액', annual.finalIncomeTax],
        ['기납부세액(소득세)', Math.round(res.tax * 12)],
        ['차감징수세액(소득세)', annual.finalIncomeTax - Math.round(res.tax * 12)],
        ['차감징수지방세(10%)', Math.round((annual.finalIncomeTax - Math.round(res.tax * 12)) * 0.10)],
      ];

      EL.annualBody.innerHTML = '';
      const data = annualFull ? rows : rows.filter(([k])=>SUMMARY_KEYS.has(k));
      EL.annualToggle.textContent = annualFull ? '요약 보기' : '전체 보기';
      EL.annualToggle.setAttribute('aria-pressed', String(annualFull));

      data.forEach(([k, v])=>{
        const isRate = k==='세율';
        const isFinal = (k==='차감징수세액(소득세)' || k==='차감징수지방세(10%)');
        const isEmph  = (k === '근로소득금액' || k === '결정세액');
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td class="p-1.5 sm:p-2 border-b text-left ${(isRate || isFinal || isEmph) ? 'tone font-semibold' : ''}">${k}</td>
          <td class="p-1.5 sm:p-2 border-b text-right num tnum ${(isRate || isFinal || isEmph) ? 'tone font-bold' : ''}">
            <span class="nowrap">${isRate ? v : NF_WON.format(v) + ' 원'}</span>
          </td>`;
        EL.annualBody.appendChild(tr);
      });
    }
    EL.annualToggle?.addEventListener('click', () => {
      annualFull = !annualFull;
      if (lastServerResult && lastServerAnnual) renderAnnualFromServer(lastServerResult, lastServerAnnual);
    });

    /* ===== 단일 계산 이벤트: 서버 호출 ===== */
    EL.calcBtn.addEventListener('click', async ()=>{
      const primary = onlyNumber(EL.netInput.value);
      const nonTax  = onlyNumber(EL.nonTaxInput.value);
      if(primary<=0){ EL.result.classList.add('hidden'); EL.error.classList.remove('hidden'); return; }

      const ownerRatePct = parseOwnerRatePctSingle();
      const mode = (inputMode==='net') ? 'net' : 'gross';
      const payload = (mode === 'net')
        ? { mode:'net', net: primary, nonTax, ownerRatePct }
        : { mode:'gross', gross: primary, nonTax, ownerRatePct };

      EL.statusSingle.textContent = '서버 계산 중…';

      try{
        const data = await callCalcAPI(payload);
        const r = data.result;

        // 상태 보관(엑셀용)
        lastServerResult = r;
        lastServerReal   = data.real;
        lastServerAnnual = {
          ...data.annual,
          // 응답에 포함 안 돼 있을 수 있는 필드 보완
          earnedIncomeTaxCredit: data.annual?.earnedIncomeTaxCredit ?? 0,
        };
        lastOwnerRatePct = ownerRatePct;
        lastInputMode    = mode;

        // 결과 바인딩
        const baseNet = r.net;
        const exclPct = (r.total_burden_excl / Math.max(1, baseNet)) * 100;
        const inclPct = (r.total_burden_incl / Math.max(1, baseNet)) * 100;

        EL.socialSum.textContent = fmt(r.social_total);
        EL.withholdSum.textContent = fmt(r.withholding_total);
        EL.overheadExcl.textContent = fmt(r.overhead_excl);
        EL.gratuity.textContent = fmt(r.gratuity);
        EL.overheadIncl.textContent = fmt(r.overhead_incl);

        EL.tbExcl.textContent = fmt(r.total_burden_excl);
        EL.tbIncl.textContent = fmt(r.total_burden_incl);
        EL.tbExclPct.textContent = fmtPct(exclPct);
        EL.tbInclPct.textContent = fmtPct(inclPct);

        // 서버 절세 반영
        EL.realBurdenExclSingle.textContent = fmt(data.real.excl);
        EL.realBurdenInclSingle.textContent = fmt(data.real.incl);
        EL.realBurdenExclSaving.textContent = NF_WON.format(data.real.savingExcl) + '원';
        EL.realBurdenInclSaving.textContent = NF_WON.format(data.real.savingIncl) + '원';

        EL.annualExcl.textContent = fmt(Math.round(r.gross * 12));
        EL.annualIncl.textContent = fmt(Math.round(r.gross * 13));
        EL.gross.textContent = fmt(r.gross);
        EL.totalDed.textContent = fmt(r.total);

        EL.np.textContent = fmt(r.np);
        EL.hi.textContent = fmt(r.hi);
        EL.ltc.textContent = fmt(r.ltc);
        EL.ei.textContent = fmt(r.ei);
        EL.tax.textContent = fmt(r.tax);
        EL.ltax.textContent = fmt(r.ltax);

        EL.np_er.textContent = fmt(r.np_er);
        EL.hi_er.textContent = fmt(r.hi_er);
        EL.ltc_er.textContent = fmt(r.ltc_er);
        EL.ei_er.textContent = fmt(r.ei_er);
        EL.wci_er.textContent = fmt(r.wci_er);
        EL.er_total.textContent = fmt(r.er_total);

        EL.baseIns.textContent = fmt(r.baseIns);
        EL.baseNP.textContent  = fmt(r.baseNP);
        EL.baseHI.textContent  = fmt(r.baseHI);
        EL.baseEI.textContent  = fmt(r.baseEI);
        EL.baseTax.textContent = fmt(r.baseTax);

        annualFull = false;
        renderAnnualFromServer(r, lastServerAnnual);

        EL.error.classList.add('hidden');
        EL.result.classList.remove('hidden');
        EL.statusSingle.textContent = '계산 완료';
        EL.exportSingleBtn.disabled = false;

        // Ver 모달 상·하한 레이블 서버 메타로 채우기 (선택)
        try {
          const metaRes = await fetch(API_BASE + '/meta');
          if (metaRes.ok) {
            const meta = await metaRes.json();
            document.getElementById('np_min_label').textContent = fmt(meta.ranges?.np?.min ?? 0);
            document.getElementById('np_max_label').textContent = fmt(meta.ranges?.np?.max ?? 0);
            document.getElementById('hi_min_label').textContent = fmt(meta.ranges?.hi?.min ?? 0);
            document.getElementById('hi_max_label').textContent = fmt(meta.ranges?.hi?.max ?? 0);
            document.getElementById('tax_zero_label').textContent = fmt(meta.taxZeroMonthly ?? 0);
          }
        } catch {}

      }catch(e){
        EL.statusSingle.textContent = 'API 오류: ' + e.message;
      }
    });

    /* ===== 다중 계산: 각 행을 서버에 병렬 호출 ===== */
    function bindCommaRowInputs(row){
      const netEl=row.querySelector('.net-input'), ntEl=row.querySelector('.nontax-input');
      bindComma(netEl); bindComma(ntEl);
      row.querySelector('.remove-row').addEventListener('click', ()=>row.remove());
    }
    function createRow(initialPrimary='', initialNT=''){
      const row = document.createElement('div');
      row.className='flex flex-col sm:flex-row gap-2';
      const placeholder = (inputMode==='net' ? '실수령액' : '지급총액');
      row.innerHTML = `
        <input type="text" inputmode="numeric" placeholder="${placeholder}" class="net-input w-full sm:w-64 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" value="${initialPrimary}">
        <input type="text" inputmode="numeric" placeholder="비과세 합계(없으면 0)" class="nontax-input w-full sm:w-64 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" value="${initialNT}">
        <button type="button" class="remove-row px-3 py-2 text-sm rounded-lg border hover:bg-gray-100">삭제</button>
      `;
      EL.multiInputs.appendChild(row);
      bindCommaRowInputs(row);
    }
    function resetMulti(){
      EL.multiInputs.innerHTML = '';
      EL.multiResults.innerHTML = '';
      createRow(); createRow();
      updateMultiPlaceholders();
    }
    EL.addRow.addEventListener('click', ()=>createRow());
    EL.resetMulti.addEventListener('click', resetMulti);
    // 초기 두 줄
    createRow(); createRow();

    EL.calcMulti.addEventListener('click', async ()=>{
      EL.multiResults.innerHTML='';
      const rows = Array.from(EL.multiInputs.children);
      if(!rows.length) createRow();

      const ownerRatePct = parseOwnerRatePct();
      const mode = (inputMode==='net') ? 'net' : 'gross';

      EL.statusMulti.textContent = '서버 계산 중…';

      const tasks = rows.map(async (r)=>{
        const primary = onlyNumber(r.querySelector('.net-input').value);
        const nonTax  = onlyNumber(r.querySelector('.nontax-input').value);
        if(primary<=0) return null;

        const payload = (mode==='net') ? { mode:'net', net: primary, nonTax, ownerRatePct }
                                       : { mode:'gross', gross: primary, nonTax, ownerRatePct };
        try{
          const data = await callCalcAPI(payload);
          const res = data.result;
          const annualSalary = Math.max(0, Math.round((res.gross - nonTax) * 12));
          const topRatePct = (data.annual?.topRate ?? 0) * 100;
          const finalIncomeTax = data.annual?.finalIncomeTax ?? 0;

          const baseNet = res.net;
          const exclPct = (res.total_burden_excl/Math.max(1, baseNet))*100;
          const inclPct = (res.total_burden_incl/Math.max(1, baseNet))*100;

          const tr = document.createElement('tr'); tr.className='border-t';
          tr.innerHTML = `
            <td class="p-2 whitespace-nowrap text-right">${fmt(res.net)}</td>
            <td class="p-2 whitespace-nowrap text-right">${fmt(nonTax)}</td>
            <td class="p-2 whitespace-nowrap text-right">${fmt(res.gross)}</td>
            <td class="p-2 whitespace-nowrap text-right">${fmt(res.total)}</td>
            <td class="p-2 whitespace-nowrap text-right">${fmt(Math.round(res.gross*12))}</td>
            <td class="p-2 whitespace-nowrap text-right">${fmt(Math.round(res.gross*13))}</td>
            <td class="p-2 whitespace-nowrap text-right">${fmt(res.total_burden_excl)}</td>
            <td class="p-2 whitespace-nowrap text-right">${fmtPct(exclPct)}</td>
            <td class="p-2 whitespace-nowrap text-right">${fmt(res.total_burden_incl)}</td>
            <td class="p-2 whitespace-nowrap text-right">${fmtPct(inclPct)}</td>
            <td class="p-2 whitespace-nowrap text-right">${fmt(annualSalary - (data.annual?.earnedDed ?? 0))}</td>
            <td class="p-2 whitespace-nowrap text-right tnum">${topRatePct.toFixed(0)} %</td>
            <td class="p-2 whitespace-nowrap text-right">${fmt(finalIncomeTax)}</td>
            <td class="p-2 whitespace-nowrap text-right">${fmt(data.real?.excl ?? 0)}</td>
            <td class="p-2 whitespace-nowrap text-right">${fmt(data.real?.incl ?? 0)}</td>`;
          return tr;
        }catch(e){
          const tr = document.createElement('tr');
          tr.innerHTML = `<td colspan="15" class="p-3 text-center text-red-500 whitespace-nowrap">API 오류: ${e.message}</td>`;
          return tr;
        }
      });

      const results = await Promise.all(tasks);
      const valid = results.filter(Boolean);
      if (!valid.length){
        const tr=document.createElement('tr');
        tr.innerHTML=`<td colspan="15" class="p-3 text-center text-gray-500 whitespace-nowrap">유효한 입력이 없습니다.</td>`;
        EL.multiResults.appendChild(tr);
      } else {
        valid.forEach(tr=>EL.multiResults.appendChild(tr));
      }
      EL.statusMulti.textContent = '계산 완료';
    });

    /* ===== Ver 모달 동작 ===== */
    function openVerModal(){ EL.verModal.classList.remove('hidden'); EL.verModal.classList.add('flex'); document.body.classList.add('overflow-hidden'); }
    function closeVerModal(){ EL.verModal.classList.add('hidden'); EL.verModal.classList.remove('flex'); document.body.classList.remove('overflow-hidden'); }
    EL.verBtn.addEventListener('click', async ()=>{
      openVerModal();
      // 서버에서 상·하한/면세 기준을 가져와 라벨 갱신
      try {
        const r = await fetch(API_BASE + '/meta');
        if (r.ok) {
          const m = await r.json();
          document.getElementById('np_min_label').textContent = fmt(m.ranges?.np?.min ?? 0);
          document.getElementById('np_max_label').textContent = fmt(m.ranges?.np?.max ?? 0);
          document.getElementById('hi_min_label').textContent = fmt(m.ranges?.hi?.min ?? 0);
          document.getElementById('hi_max_label').textContent = fmt(m.ranges?.hi?.max ?? 0);
          document.getElementById('tax_zero_label').textContent = fmt(m.taxZeroMonthly ?? 0);
        }
      } catch {}
    });
    EL.verClose.addEventListener('click', closeVerModal);
    EL.verOk.addEventListener('click', closeVerModal);
    EL.verModal.addEventListener('click', (e)=>{ const dialog=EL.verModal.querySelector('[role="dialog"]'); if(!dialog.contains(e.target)) closeVerModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeVerModal(); });

    /* ===== 엑셀 내보내기(단일) - 서버 응답 사용 ===== */
    EL.exportSingleBtn.addEventListener('click', ()=>{
      if(!lastServerResult) return;
      const now = new Date();
      const y = now.getFullYear(), m = String(now.getMonth()+1).padStart(2,'0'), d = String(now.getDate()).padStart(2,'0');

      const sheet1 = [
        ['입력 기준', lastInputMode==='net' ? '실수령' : '지급총액'],
        ['대표자 세율(%)', lastOwnerRatePct],
        [],
        ['실수령액', lastServerResult.net],
        ['비과세(월)', lastServerResult.nonTax],
        ['지급총액', lastServerResult.gross],
        ['공제합계(근로자)', lastServerResult.total],
        [],
        ['연봉(퇴직금 제외)', Math.round(lastServerResult.gross*12)],
        ['연봉(퇴직금 포함)', Math.round(lastServerResult.gross*13)],
        [],
        ['총부담(퇴직금 제외)', lastServerResult.total_burden_excl],
        ['총부담(퇴직금 포함)', lastServerResult.total_burden_incl],
        ['실부담(퇴직금 제외)', lastServerReal?.excl ?? 0],
        ['실부담(퇴직금 포함)', lastServerReal?.incl ?? 0],
        ['절세액(제외)', lastServerReal?.savingExcl ?? 0],
        ['절세액(포함)', lastServerReal?.savingIncl ?? 0],
        [],
        ['4대보험(근로자+사업주)', lastServerResult.social_total],
        ['원천세(소득세+지방세)', lastServerResult.withholding_total],
        ['부대비용 총액(퇴직금 제외)', lastServerResult.overhead_excl],
        ['퇴직금(월지급총액의 1/12)', lastServerResult.gratuity],
        ['부대비용 총액(퇴직금 포함)', lastServerResult.overhead_incl],
      ];

      const sheet2 = [
        ['구분','금액'],
        ['국민연금(근로자)', lastServerResult.np],
        ['건강보험(근로자)', lastServerResult.hi],
        ['장기요양(근로자)', lastServerResult.ltc],
        ['고용보험(근로자)', lastServerResult.ei],
        ['소득세', lastServerResult.tax],
        ['지방소득세', lastServerResult.ltax],
        [],
        ['국민연금(사업주)', lastServerResult.np_er],
        ['건강보험(사업주)', lastServerResult.hi_er],
        ['장기요양(사업주)', lastServerResult.ltc_er],
        ['고용보험(사업주)', lastServerResult.ei_er],
        ['산재보험(사업주)', lastServerResult.wci_er],
        ['4대보험 사업주 부담 합계', lastServerResult.er_total],
        [],
        ['보수월액(비과세 제외)', lastServerResult.baseIns],
        ['국민연금 기준소득(천원단위)', lastServerResult.baseNP],
        ['건강보험 산정기준', lastServerResult.baseHI],
        ['고용보험 산정기준', lastServerResult.baseEI],
        ['간이세액표 기준금액', lastServerResult.baseTax],
      ];

      // 연간표: 화면에 보이는 내용 그대로 수집
      const tableRows = Array.from(EL.annualBody.querySelectorAll('tr'));
      const sheet3 = [['구분','금액']];
      tableRows.forEach(tr=>{
        const tds = tr.querySelectorAll('td');
        const k = tds[0]?.innerText?.trim() ?? '';
        const vText = tds[1]?.innerText?.replace(/[^\d\-]/g,'') ?? '0';
        const v = Number(vText) || 0;
        sheet3.push([k, v]);
      });

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sheet1), '요약(단일)');
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sheet2), '공제상세');
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sheet3), '연간내역');
      XLSX.writeFile(wb, `네트급여_단일_${y}${m}${d}.xlsx`);
    });

    /* ===== 다중 엑셀 내보내기: 표 그대로 ===== */
    EL.exportMultiBtn.addEventListener('click', ()=>{
      const rows = Array.from(EL.multiResults.querySelectorAll('tr'));
      if(!rows.length || rows[0].querySelector('td[colspan]')){
        alert('내보낼 다중 결과가 없습니다. 먼저 "다중 계산"을 눌러주세요.');
        return;
      }
      const now = new Date();
      const y = now.getFullYear(), m = String(now.getMonth()+1).padStart(2,'0'), d = String(now.getDate()).padStart(2,'0');

      const headerCells = Array.from(document.querySelector('#content_multi thead tr').children);
      const headers = headerCells.map(th => th.innerText.replace(/\s+/g,' ').trim());

      const data = [headers];
      rows.forEach(tr=>{
        const tds = Array.from(tr.children);
        const row = tds.map(td=>{
          const txt = td.innerText.trim();
          if (txt.endsWith('%')) return Number(txt.replace(/[^\d.\-]/g,'')) || txt;
          const num = Number(txt.replace(/[^\d\-]/g,''));
          return Number.isFinite(num) && txt.includes('원') ? num : txt;
        });
        data.push(row);
      });

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(data), '다중결과');
      const meta = [
        ['입력 기준', inputMode==='net' ? '실수령' : '지급총액'],
        ['대표자 세율(%)', parseOwnerRatePct()],
        ['행 개수', rows.length]
      ];
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(meta), '메타');
      XLSX.writeFile(wb, `네트급여_다중_${y}${m}${d}.xlsx`);
    });
  </script>
</body>
</html>
